<!-- This file was written by Cluade 4.6 LLM via the prompt of Josh Kirby -->
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Fourier Explorer v5 ‚Äî TECHIN 513A</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@400;500;600;700&family=Newsreader:ital,wght@0,400;0,500;0,600;1,400&display=swap');
            :root {
                --bg: #06060b;
                --s: rgba(255, 255, 255, 0.025);
                --sh: rgba(255, 255, 255, 0.05);
                --bd: rgba(255, 255, 255, 0.07);
                --ba: #7c3aed;
                --ac: #a78bfa;
                --ad: rgba(124, 58, 237, 0.12);
                --gn: #34d399;
                --gd: rgba(52, 211, 153, 0.12);
                --am: #fbbf24;
                --amd: rgba(251, 191, 36, 0.1);
                --rs: #fb7185;
                --rsd: rgba(251, 113, 133, 0.1);
                --cy: #22d3ee;
                --cyd: rgba(34, 211, 238, 0.1);
                --tx: #d4d4e0;
                --td: rgba(255, 255, 255, 0.4);
                --tm: rgba(255, 255, 255, 0.22);
                --mo: 'DM Mono', 'SF Mono', monospace;
                --sn: 'Outfit', -apple-system, sans-serif;
                --se: 'Newsreader', Georgia, serif;
                --extract-color: #22d3ee;
                --extract-dim: rgba(34, 211, 238, 0.15);
            }
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            ::selection {
                background: #7c3aed;
                color: #fff;
            }
            body {
                background: var(--bg);
                color: var(--tx);
                font-family: var(--sn);
                min-height: 100vh;
                padding: 24px 16px 270px;
            }
            .ctn {
                max-width: 900px;
                margin: 0 auto;
            }
            h1 {
                font-size: 24px;
                font-weight: 700;
                letter-spacing: -0.03em;
                background: linear-gradient(135deg, #c4b5fd, #60a5fa, #22d3ee);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 3px;
            }
            .sub {
                font-family: var(--mo);
                font-size: 11px;
                color: var(--td);
                margin-bottom: 22px;
            }
            .sec {
                margin-bottom: 18px;
            }
            .sl {
                font-family: var(--mo);
                font-size: 10px;
                font-weight: 600;
                color: var(--td);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                margin-bottom: 7px;
            }
            .uz {
                border: 2px dashed var(--bd);
                border-radius: 10px;
                padding: 20px;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s;
                background: var(--s);
            }
            .uz:hover,
            .uz.dg {
                border-color: var(--ba);
                background: var(--ad);
            }
            .uz input {
                display: none;
            }
            .ui {
                font-size: 22px;
                margin-bottom: 3px;
                opacity: 0.5;
            }
            .ut {
                font-family: var(--mo);
                font-size: 11px;
                color: var(--td);
            }
            .ut strong {
                color: var(--ac);
            }
            .uh {
                font-family: var(--mo);
                font-size: 9px;
                color: var(--tm);
                margin-top: 2px;
            }
            .fi {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 7px 12px;
                background: var(--ad);
                border: 1px solid rgba(124, 58, 237, 0.2);
                border-radius: 8px;
                font-family: var(--mo);
                font-size: 11px;
            }
            .fi .fn {
                color: var(--ac);
                font-weight: 500;
                flex: 1;
            }
            .fi .fm {
                color: var(--td);
            }
            .fi button {
                background: none;
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: var(--td);
                border-radius: 5px;
                padding: 2px 7px;
                cursor: pointer;
                font-family: var(--mo);
                font-size: 9px;
            }
            .bg {
                display: flex;
                gap: 4px;
                flex-wrap: wrap;
            }
            .bt {
                font-family: var(--mo);
                font-size: 10px;
                padding: 5px 11px;
                border-radius: 5px;
                border: 1px solid var(--bd);
                background: var(--s);
                color: var(--td);
                cursor: pointer;
                transition: all 0.12s;
                white-space: nowrap;
            }
            .bt:hover {
                background: var(--sh);
                color: var(--tx);
            }
            .bt.ac {
                border-color: var(--ba);
                background: var(--ad);
                color: var(--ac);
            }
            [data-l] {
                cursor: pointer;
            }
            .tr {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 7px 12px;
                background: var(--s);
                border: 1px solid var(--bd);
                border-radius: 8px;
                margin-bottom: 8px;
                flex-wrap: wrap;
            }
            .tb {
                width: 30px;
                height: 30px;
                border-radius: 50%;
                border: 1px solid var(--bd);
                background: var(--s);
                color: var(--td);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 13px;
                transition: all 0.15s;
                flex-shrink: 0;
            }
            .tb:hover {
                border-color: var(--ac);
                color: var(--ac);
                background: var(--ad);
            }
            .tb.pl {
                border-color: var(--gn);
                background: var(--gd);
                color: var(--gn);
            }
            .tb.ext {
                border-color: var(--cy);
                background: var(--cyd);
                color: var(--cy);
            }
            .tt {
                font-family: var(--mo);
                font-size: 11px;
                color: var(--ac);
                min-width: 85px;
                font-weight: 500;
            }
            .ts {
                flex: 1;
                min-width: 80px;
                -webkit-appearance: none;
                height: 3px;
                background: rgba(255, 255, 255, 0.08);
                border-radius: 2px;
                outline: none;
            }
            .ts::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 11px;
                height: 11px;
                border-radius: 50%;
                background: var(--ac);
                cursor: pointer;
                border: 2px solid var(--bg);
            }
            .at {
                display: flex;
                align-items: center;
                gap: 6px;
            }
            .at span {
                font-family: var(--mo);
                font-size: 9px;
                color: var(--td);
            }
            .tg {
                width: 36px;
                height: 18px;
                border-radius: 9px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid var(--bd);
                cursor: pointer;
                position: relative;
                transition: all 0.2s;
            }
            .tg.on {
                background: var(--ad);
                border-color: var(--ba);
            }
            .tg .kn {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: var(--td);
                position: absolute;
                top: 2px;
                left: 2px;
                transition: all 0.2s;
            }
            .tg.on .kn {
                left: 20px;
                background: var(--ac);
            }
            .tg.cy.on {
                background: var(--cyd);
                border-color: var(--cy);
            }
            .tg.cy.on .kn {
                background: var(--cy);
            }
            .sr {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 7px;
            }
            .srl {
                font-family: var(--mo);
                font-size: 9px;
                color: var(--td);
                min-width: 90px;
            }
            .srv {
                font-family: var(--mo);
                font-size: 10px;
                color: var(--ac);
                min-width: 50px;
                text-align: right;
                font-weight: 500;
            }
            input[type='range'] {
                flex: 1;
                -webkit-appearance: none;
                height: 3px;
                background: rgba(255, 255, 255, 0.08);
                border-radius: 2px;
                outline: none;
            }
            input[type='range']::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: var(--ac);
                cursor: pointer;
                border: 2px solid var(--bg);
            }
            .tabs {
                display: flex;
                gap: 2px;
                background: var(--s);
                border-radius: 8px;
                padding: 3px;
                margin-bottom: 12px;
            }
            .tab {
                flex: 1;
                padding: 8px 8px;
                border-radius: 6px;
                border: none;
                background: transparent;
                color: var(--td);
                font-family: var(--mo);
                font-size: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.15s;
            }
            .tab.ac {
                background: var(--ad);
                color: var(--ac);
            }
            .cw {
                border-radius: 6px;
                overflow: hidden;
                border: 1px solid var(--bd);
                margin-bottom: 3px;
                position: relative;
            }
            .cw canvas {
                display: block;
                width: 100%;
            }
            .cc {
                font-family: var(--mo);
                font-size: 9px;
                color: var(--tm);
                margin-bottom: 10px;
            }
            .lb {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                font-family: var(--mo);
                font-size: 9px;
                color: var(--gn);
                padding: 2px 6px;
                background: var(--gd);
                border-radius: 3px;
                margin-left: 5px;
            }
            .ld {
                width: 5px;
                height: 5px;
                border-radius: 50%;
                background: var(--gn);
                animation: pu 1.2s infinite;
            }
            @keyframes pu {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.3;
                }
            }
            .pg {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                margin-bottom: 14px;
            }
            .pc {
                background: var(--s);
                border: 1px solid var(--bd);
                border-radius: 6px;
                padding: 7px 10px;
                flex: 1 1 110px;
                min-width: 105px;
                cursor: pointer;
                transition: border-color 0.15s;
            }
            .pc:hover {
                border-color: var(--am);
            }
            .pc .pl {
                font-family: var(--mo);
                font-size: 9px;
                color: var(--td);
                margin-bottom: 1px;
            }
            .pc .pv {
                font-family: var(--mo);
                font-size: 15px;
                font-weight: 700;
                color: var(--ac);
            }
            .pc .pv .pu {
                font-size: 9px;
                color: var(--td);
                font-weight: 400;
                margin-left: 2px;
            }
            .pc .pd {
                font-family: var(--mo);
                font-size: 8px;
                color: var(--tm);
                margin-top: 1px;
            }
            .cg {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-bottom: 10px;
            }
            @media (max-width: 640px) {
                .cg {
                    grid-template-columns: 1fr;
                }
            }
            .cg label {
                display: block;
                font-family: var(--mo);
                font-size: 9px;
                color: var(--td);
                margin-bottom: 4px;
            }
            .aol {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-family: var(--mo);
                font-size: 11px;
                color: var(--tm);
                pointer-events: none;
                text-align: center;
            }
            .pr {
                margin-bottom: 10px;
            }
            .ft {
                text-align: center;
                font-family: var(--mo);
                font-size: 9px;
                color: var(--tm);
                padding-top: 14px;
            }

            /* Extract band indicator */
            .band-indicator {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 8px 14px;
                background: var(--cyd);
                border: 1px solid rgba(34, 211, 238, 0.2);
                border-radius: 8px;
                margin-bottom: 10px;
                font-family: var(--mo);
                font-size: 11px;
                color: var(--cy);
            }
            .band-indicator .bi-label {
                flex: 1;
            }

            /* FS */
            .fsn {
                font-family: var(--se);
                font-size: 12px;
                color: rgba(255, 255, 255, 0.5);
                line-height: 1.6;
                margin: 8px 0;
                padding: 8px 12px;
                border-left: 3px solid var(--am);
                background: var(--amd);
                border-radius: 0 5px 5px 0;
            }
            .fss {
                max-height: 350px;
                overflow-y: auto;
                border: 1px solid var(--bd);
                border-radius: 7px;
                background: rgba(0, 0, 0, 0.3);
                padding: 3px;
            }
            .fss::-webkit-scrollbar {
                width: 5px;
            }
            .fss::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
            }
            .fhr {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 2px 6px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            }
            .fhr:last-child {
                border-bottom: none;
            }
            .fhl {
                font-family: var(--mo);
                font-size: 9px;
                color: var(--td);
                min-width: 100px;
            }
            .fhl strong {
                color: var(--ac);
            }
            .fhc {
                flex: 1;
                height: 32px;
                border-radius: 3px;
            }

            /* Lesson */
            .lp {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #0c0c14;
                border-top: 1px solid rgba(251, 191, 36, 0.2);
                box-shadow: 0 -6px 30px rgba(0, 0, 0, 0.6);
                z-index: 100;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                max-height: 240px;
                overflow: hidden;
            }
            .lp.co {
                transform: translateY(calc(100% - 34px));
            }
            .lh {
                display: flex;
                align-items: center;
                gap: 7px;
                padding: 6px 16px;
                cursor: pointer;
                user-select: none;
                background: rgba(251, 191, 36, 0.04);
                border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            }
            .lhi {
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: var(--am);
                color: var(--bg);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                font-weight: 700;
                font-family: var(--mo);
                flex-shrink: 0;
            }
            .lht {
                font-family: var(--mo);
                font-size: 10px;
                font-weight: 600;
                color: var(--am);
                flex: 1;
            }
            .lhh {
                font-family: var(--mo);
                font-size: 8px;
                color: var(--tm);
            }
            .lhc {
                font-size: 11px;
                color: var(--td);
                transition: transform 0.3s;
            }
            .lp.co .lhc {
                transform: rotate(180deg);
            }
            .lby {
                padding: 10px 18px 14px;
                overflow-y: auto;
                max-height: 195px;
                line-height: 1.7;
            }
            .lby h3 {
                font-family: var(--sn);
                font-size: 14px;
                font-weight: 600;
                color: var(--am);
                margin-bottom: 5px;
            }
            .lby p {
                font-family: var(--se);
                font-size: 12px;
                color: rgba(255, 255, 255, 0.6);
                margin-bottom: 6px;
            }
            .lby code {
                font-family: var(--mo);
                font-size: 10px;
                color: var(--ac);
                background: rgba(167, 139, 250, 0.1);
                padding: 1px 4px;
                border-radius: 3px;
            }
            .lby .fm {
                font-family: var(--mo);
                font-size: 11px;
                color: var(--gn);
                background: rgba(52, 211, 153, 0.06);
                border: 1px solid rgba(52, 211, 153, 0.12);
                border-radius: 4px;
                padding: 5px 10px;
                margin: 5px 0;
                display: inline-block;
            }
            .lby .kp {
                border-left: 3px solid var(--am);
                padding-left: 10px;
                margin: 6px 0;
                font-family: var(--se);
                font-style: italic;
                color: rgba(255, 255, 255, 0.5);
            }
        </style>
    </head>
    <body>
        <div class="ctn">
            <h1>Fourier Explorer</h1>
            <p class="sub">
                Analyze ¬∑ Extract ¬∑ Listen ‚Äî hear what individual frequencies
                sound like
            </p>

            <!-- Upload -->
            <div class="sec">
                <div class="sl">Audio Source</div>
                <div
                    id="uz"
                    class="uz"
                    data-l="fi"
                    onclick="
                        $('fin').click();
                        L('fi');
                    "
                >
                    <input
                        type="file"
                        id="fin"
                        accept=".wav,.mp3,.ogg,.flac,.m4a"
                    />
                    <div class="ui">üéô</div>
                    <div class="ut">
                        Drop <strong>audio</strong> here or click
                    </div>
                    <div class="uh">WAV¬∑MP3¬∑OGG¬∑FLAC¬∑M4A</div>
                </div>
                <div id="finfo" class="fi" style="display: none">
                    <span class="fn" id="fname"></span
                    ><span class="fm" id="fmeta"></span
                    ><button onclick="ldP(S.preset || 'tones')">Clear</button>
                </div>
                <div class="pr" style="margin-top: 8px">
                    <div class="sl">Synthetic signals</div>
                    <div class="bg" id="pBtns">
                        <button class="bt ac" data-p="tones" data-l="pre">
                            440+1k+2.5k</button
                        ><button class="bt" data-p="chirp" data-l="pre">
                            Chirp</button
                        ><button class="bt" data-p="impulses" data-l="pre">
                            Impulses</button
                        ><button class="bt" data-p="chord" data-l="pre">
                            C Major</button
                        ><button class="bt" data-p="square" data-l="pre">
                            Square
                        </button>
                    </div>
                </div>
            </div>

            <!-- Transport -->
            <div class="sec">
                <div class="sl">Playback</div>
                <div class="tr">
                    <button
                        class="tb"
                        id="playB"
                        data-l="pb"
                        onclick="
                            togPlay();
                            L('pb');
                        "
                    >
                        ‚ñ∂
                    </button>
                    <button class="tb" onclick="stopA()">‚ñ†</button>
                    <span class="tt" id="tDisp">0:00.0 / 0:00.0</span>
                    <input
                        type="range"
                        class="ts"
                        id="seek"
                        min="0"
                        max="1000"
                        value="0"
                        step="1"
                    />
                    <div class="at">
                        <span>Listen to</span>
                        <button
                            class="tb"
                            id="extPlayB"
                            onclick="togExtPlay()"
                            title="Toggle: Original vs Extracted"
                            style="
                                width: auto;
                                border-radius: 5px;
                                padding: 0 8px;
                                font-size: 9px;
                                font-family: var(--mo);
                            "
                        >
                            ORIGINAL
                        </button>
                    </div>
                    <div class="at" data-l="extToggle" onclick="L('extToggle')">
                        <span>Overlay</span>
                        <div class="tg cy on" id="ovTog" onclick="togOverlay()">
                            <div class="kn"></div>
                        </div>
                    </div>
                    <div
                        class="at"
                        data-l="anTog"
                        onclick="
                            togAn();
                            L('anTog');
                        "
                    >
                        <span>Analysis</span>
                        <div class="tg on" id="anTog">
                            <div class="kn"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Band selector -->
            <div class="sec" id="bandSec">
                <div class="sl" data-l="bandSel" onclick="L('bandSel')">
                    Frequency Band Extraction
                    <span style="color: var(--cy); font-weight: 400"
                        >¬∑ cyan = extracted</span
                    >
                </div>
                <div class="cg">
                    <div>
                        <div class="sr">
                            <span class="srl">Low cutoff</span
                            ><input
                                type="range"
                                id="bandLo"
                                min="0"
                                max="22050"
                                step="10"
                                value="0"
                            /><span class="srv" id="bandLoV">0 Hz</span>
                        </div>
                    </div>
                    <div>
                        <div class="sr">
                            <span class="srl">High cutoff</span
                            ><input
                                type="range"
                                id="bandHi"
                                min="0"
                                max="22050"
                                step="10"
                                value="22050"
                            /><span class="srv" id="bandHiV">22050 Hz</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Waveform -->
            <div class="sec">
                <div class="sl" data-l="wf" onclick="L('wf')">
                    Waveform
                    <span class="lb" id="livB" style="display: none"
                        ><span class="ld"></span>LIVE</span
                    >
                </div>
                <div class="cw" data-l="wf" onclick="L('wf')">
                    <canvas id="wC" height="110"></canvas>
                </div>
                <div class="cc" id="wCap"></div>
            </div>

            <!-- Tabs -->
            <div class="tabs" id="mTabs">
                <button class="tab ac" data-t="fft" data-l="fftT">FFT</button>
                <button class="tab" data-t="stft" data-l="stftT">STFT</button>
                <button class="tab" data-t="fs" data-l="fsT">
                    Fourier Series
                </button>
            </div>

            <!-- FFT/STFT Controls -->
            <div id="fsCtrls">
                <div class="cg">
                    <div data-l="wfn" onclick="L('wfn')">
                        <label>Window</label>
                        <div class="bg" id="wBtns">
                            <button class="bt" data-w="rectangular" data-l="wr">
                                rect</button
                            ><button class="bt ac" data-w="hann" data-l="wh">
                                hann</button
                            ><button class="bt" data-w="hamming" data-l="whm">
                                hamming</button
                            ><button class="bt" data-w="blackman" data-l="wb">
                                blackman
                            </button>
                        </div>
                    </div>
                    <div data-l="mf" onclick="L('mf')">
                        <div class="sr">
                            <span class="srl">Max freq</span
                            ><input
                                type="range"
                                id="mfS"
                                min="500"
                                max="22050"
                                step="250"
                                value="8000"
                            /><span class="srv" id="mfV">8000 Hz</span>
                        </div>
                    </div>
                </div>
                <div class="cg">
                    <div data-l="zp" onclick="L('zp')">
                        <label>Zero-Pad</label>
                        <div class="bg" id="zpB">
                            <button class="bt ac" data-z="1">1√ó</button
                            ><button class="bt" data-z="2">2√ó</button
                            ><button class="bt" data-z="4">4√ó</button>
                        </div>
                    </div>
                    <div data-l="dr" onclick="L('dr')">
                        <div class="sr">
                            <span class="srl">Dynamic range</span
                            ><input
                                type="range"
                                id="drS"
                                min="20"
                                max="120"
                                step="5"
                                value="60"
                            /><span class="srv" id="drV">60 dB</span>
                        </div>
                    </div>
                </div>
                <div id="stC" style="display: none">
                    <div class="cg">
                        <div data-l="nf" onclick="L('nf')">
                            <label>n_fft</label>
                            <div class="bg" id="nfB">
                                <button class="bt" data-n="256">256</button
                                ><button class="bt" data-n="512">512</button
                                ><button class="bt ac" data-n="1024">
                                    1024</button
                                ><button class="bt" data-n="2048">2048</button
                                ><button class="bt" data-n="4096">4096</button>
                            </div>
                        </div>
                        <div data-l="ol" onclick="L('ol')">
                            <div class="sr">
                                <span class="srl">Overlap</span
                                ><input
                                    type="range"
                                    id="olS"
                                    min="0"
                                    max="90"
                                    step="5"
                                    value="75"
                                /><span class="srv" id="olV">75%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FS Controls -->
            <div id="fSerC" style="display: none">
                <div class="fsn">
                    <strong>Fourier Series:</strong> Select a window ‚Üí see it
                    tiled as periodic ‚Üí watch individual harmonics. Use the
                    harmonics slider to reconstruct progressively.
                </div>
                <div class="cg">
                    <div data-l="fsW" onclick="L('fsW')">
                        <label>Window size</label>
                        <div class="sr">
                            <input
                                type="range"
                                id="fsWS"
                                min="64"
                                max="4096"
                                step="64"
                                value="512"
                            /><span class="srv" id="fsWV">512</span>
                        </div>
                    </div>
                    <div data-l="fsH" onclick="L('fsH')">
                        <label>Harmonics</label>
                        <div class="sr">
                            <input
                                type="range"
                                id="fsHS"
                                min="1"
                                max="64"
                                step="1"
                                value="8"
                            /><span class="srv" id="fsHV">8</span>
                        </div>
                    </div>
                </div>
                <div class="cg">
                    <div data-l="fsO" onclick="L('fsO')">
                        <label>Window offset</label>
                        <div class="sr">
                            <input
                                type="range"
                                id="fsOS"
                                min="0"
                                max="1000"
                                step="1"
                                value="0"
                            /><span class="srv" id="fsOV">0</span>
                        </div>
                    </div>
                    <div></div>
                </div>
            </div>

            <!-- Main viz -->
            <div class="sec">
                <div class="cw" id="mCW">
                    <canvas id="mC" height="300"></canvas>
                    <div class="aol" id="anOff" style="display: none">
                        Analysis OFF
                    </div>
                </div>
                <div class="cc" id="mCap"></div>
            </div>

            <!-- Live spec -->
            <div class="sec" id="livS" style="display: none">
                <div class="sl">
                    Live Spectrum
                    <span class="lb"><span class="ld"></span>REAL-TIME</span>
                </div>
                <div class="cw"><canvas id="livC" height="150"></canvas></div>
            </div>

            <!-- FS viz -->
            <div id="fsViz" style="display: none">
                <div class="sec">
                    <div class="sl" data-l="fsR" onclick="L('fsR')">
                        Reconstruction
                    </div>
                    <div class="cw">
                        <canvas id="fsRC" height="90"></canvas>
                    </div>
                    <div class="cc" id="fsRCap"></div>
                </div>
                <div class="sec">
                    <div class="sl" data-l="fsHr" onclick="L('fsHr')">
                        Individual Harmonics
                    </div>
                    <div class="fss" id="fsScr"></div>
                </div>
            </div>

            <!-- Params -->
            <div class="sec">
                <div class="sl">
                    Parameters
                    <span
                        style="
                            font-weight: 400;
                            color: var(--am);
                            font-size: 8px;
                        "
                        >click for lesson</span
                    >
                </div>
                <div class="pg" id="pG"></div>
            </div>
            <div class="ft">TECHIN 513A ¬∑ Fourier Transform Fundamentals</div>
        </div>

        <!-- Lesson -->
        <div class="lp" id="lP">
            <div class="lh" onclick="togLP()">
                <div class="lhi">?</div>
                <div class="lht" id="lT">Click any parameter for a lesson</div>
                <div class="lhh">click to toggle</div>
                <div class="lhc" id="lCh">‚ñº</div>
            </div>
            <div class="lby" id="lB">
                <h3>Welcome</h3>
                <p>
                    Click any control, slider, button, or parameter card. The
                    <strong>Fourier Series</strong> tab shows signal
                    decomposition into sine waves. The
                    <strong>frequency band</strong> selector lets you isolate
                    and <em>listen to</em> specific frequency ranges ‚Äî click
                    "ORIGINAL" in the transport bar to switch to "EXTRACTED" and
                    hear only the selected band.
                </p>
                <div class="kp">
                    Space = play/pause ¬∑ Esc = stop ¬∑ A = analysis toggle ¬∑ E =
                    extraction toggle
                </div>
            </div>
        </div>

        <script>
            const $ = id => document.getElementById(id);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // LESSONS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const LS = {
                wf: {
                    t: 'Waveform',
                    b: '<h3>Waveform</h3><p>Amplitude vs time. When the <span style="color:#22d3ee">cyan overlay</span> is on, the extracted frequency band is drawn on top of the original (blue) waveform. This lets you visually see which parts of the signal fall within your selected band.</p><div class="kp">The audio you hear during "ORIGINAL" mode is unchanged. In "EXTRACTED" mode, you hear only the cyan portion ‚Äî everything outside your band has been removed via inverse FFT.</div>',
                },
                fftT: {
                    t: 'FFT',
                    b: '<h3>FFT</h3><p>Decomposes the signal into frequency bins. The <span style="color:#22d3ee">cyan highlighted region</span> on the spectrum shows your selected extraction band. Everything inside this band can be isolated and played back.</p><div class="fm">X[k] = Œ£ x[n] ¬∑ e^(-j¬∑2œÄ¬∑k¬∑n/N)</div>',
                },
                stftT: {
                    t: 'STFT',
                    b: '<h3>STFT</h3><p>Spectrogram view. The extraction band appears as a <span style="color:#22d3ee">cyan horizontal band</span> overlaid on the spectrogram, showing which frequencies are being extracted at every time step.</p>',
                },
                fsT: {
                    t: 'Fourier Series',
                    b: '<h3>Fourier Series</h3><p>Decomposes a periodic window into individual sine waves. Each harmonic is shown separately. The reconstruction (green) converges on the original (white) as you add harmonics.</p><div class="kp">In "EXTRACTED" playback mode with the Fourier Series tab, you hear the reconstruction from the selected number of harmonics ‚Äî letting you hear what each harmonic contributes.</div>',
                },
                bandSel: {
                    t: 'Frequency Band Extraction',
                    b: '<h3>Band Extraction</h3><p>This is the core new feature. Set a low and high frequency cutoff to define a <em>bandpass filter</em>. The tool computes the FFT of your entire signal, zeros out all bins outside this range, then inverse-FFTs back to get the filtered audio.</p><p>Toggle the playback to <strong>EXTRACTED</strong> to hear only the frequencies in your band. The <span style="color:#22d3ee">cyan overlay</span> on the waveform shows this filtered signal in real time.</p><div class="kp">Try isolating 400-500 Hz on the three-tone preset ‚Äî you\'ll hear only the 440 Hz component. Or on a real recording, isolate 2000-4000 Hz to hear just the high-frequency content like sibilance, hissing, or the snap of percussive sounds.</div>',
                },
                extToggle: {
                    t: 'Extraction Overlay',
                    b: '<h3>Overlay Toggle</h3><p>When on, the extracted (bandpass-filtered) signal is drawn in <span style="color:#22d3ee">cyan</span> over the original blue waveform. This visual overlay lets you see exactly which parts of the audio fall within your selected frequency band.</p><p>Loud regions of cyan = lots of energy in your band. Regions where cyan is flat but blue is active = energy outside your band.</p>',
                },
                anTog: {
                    t: 'Analysis Toggle',
                    b: '<h3>Analysis On/Off</h3><p>Toggles the FFT/STFT visualization. Audio playback and extraction still work with analysis off.</p>',
                },
                pb: {
                    t: 'Playback',
                    b: '<h3>Playback & Extraction</h3><p>The "ORIGINAL / EXTRACTED" button switches what you <em>hear</em>:</p><p><strong>ORIGINAL:</strong> The unmodified audio signal.</p><p><strong>EXTRACTED:</strong> Only the frequencies within your selected band (bandpass filtered via inverse FFT). In Fourier Series mode, you hear the reconstruction from the selected harmonics.</p><div class="kp">This is where analysis becomes tangible. You\'re not just seeing frequency content ‚Äî you\'re hearing it isolated. This is conceptually identical to what NMF source separation does in your project: decompose a signal into components, then reconstruct only the ones you want.</div>',
                },
                nf: {
                    t: 'n_fft',
                    b: '<h3>n_fft</h3><p>Controls the time-frequency tradeoff. Larger = finer freq resolution, coarser time. The extraction band resolution also depends on this ‚Äî more bins within your band = cleaner isolation.</p><div class="fm">Œîf = fs / n_fft</div>',
                },
                ol: {
                    t: 'Overlap',
                    b: '<h3>Overlap</h3><div class="fm">hop = n_fft √ó (1 - overlap%)</div><p>75% is standard for analysis. Higher overlap = smoother time axis.</p>',
                },
                wfn: {
                    t: 'Window Function',
                    b: '<h3>Window Functions</h3><p>Tapers signal edges to prevent spectral leakage. The FFT assumes periodicity ‚Äî the window smooths the boundary.</p>',
                },
                wr: {
                    t: 'Rectangular',
                    b: '<h3>Rectangular</h3><p>No taper. Sharpest peaks but worst leakage (-13 dB). Rarely used.</p>',
                },
                wh: {
                    t: 'Hann',
                    b: '<h3>Hann</h3><p>The default. -31 dB sidelobes, fast rolloff. Use this.</p>',
                },
                whm: {
                    t: 'Hamming',
                    b: '<h3>Hamming</h3><p>Better first sidelobe (-42 dB) but slower rolloff. Speech processing default.</p>',
                },
                wb: {
                    t: 'Blackman',
                    b: '<h3>Blackman</h3><p>Strongest suppression (-58 dB), widest main lobe.</p>',
                },
                zp: {
                    t: 'Zero-Padding',
                    b: '<h3>Zero-Padding</h3><p>Interpolates between bins (smoother curve). Does NOT improve real resolution.</p>',
                },
                dr: {
                    t: 'Dynamic Range',
                    b: '<h3>Dynamic Range</h3><p>dB floor for display. 60 dB = signals down to 1/1000th of peak.</p>',
                },
                mf: {
                    t: 'Max Frequency',
                    b: '<h3>Max Display Freq</h3><p>Display crop only. Most household sounds < 8 kHz.</p>',
                },
                pre: {
                    t: 'Presets',
                    b: '<h3>Presets</h3><p><strong>3 Tones:</strong> Try band-extracting 400-500 Hz to isolate the 440 Hz tone. <strong>Square:</strong> Only odd harmonics visible in Fourier Series. <strong>Chirp:</strong> Sweep visible as diagonal in STFT.</p>',
                },
                fi: {
                    t: 'File Input',
                    b: '<h3>Audio Loading</h3><p>Browser decodes via Web Audio API. Stereo mixed to mono. 30s max.</p>',
                },
                pfs: {
                    t: 'Sample Rate',
                    b: '<h3>fs</h3><p>Samples/sec. Nyquist = fs/2.</p>',
                },
                pny: {
                    t: 'Nyquist',
                    b: '<h3>Nyquist</h3><p>Max representable frequency = fs/2.</p>',
                },
                pN: {
                    t: 'N',
                    b: '<h3>N</h3><p>Total samples. Duration = N/fs.</p>',
                },
                pdf: {
                    t: 'Œîf',
                    b: '<h3>Œîf</h3><p>Frequency resolution = fs/n_fft.</p>',
                },
                pdt: {
                    t: 'Œît',
                    b: '<h3>Œît</h3><p>Time resolution = hop/fs.</p>',
                },
                pbn: {
                    t: 'Bins',
                    b: '<h3>Freq Bins</h3><p>n_fft/2 + 1 unique bins.</p>',
                },
                pfr: {
                    t: 'Frames',
                    b: '<h3>Time Frames</h3><p>‚âà (N-n_fft)/hop + 1 columns.</p>',
                },
                psh: {
                    t: 'Shape',
                    b: '<h3>Shape</h3><p>Spectrogram matrix dimensions.</p>',
                },
                fsW: {
                    t: 'FS Window',
                    b: '<h3>FS Window Size</h3><p>Samples per period. Fundamental = fs/window_size.</p>',
                },
                fsH: {
                    t: 'Harmonics',
                    b: '<h3>Harmonics</h3><p>How many sine components to include. More = better reconstruction.</p>',
                },
                fsO: {
                    t: 'Offset',
                    b: '<h3>Window Position</h3><p>Where in the audio to grab the period.</p>',
                },
                fsR: {
                    t: 'Reconstruction',
                    b: '<h3>Reconstruction</h3><p>White = original. Green = sum of harmonics. In EXTRACTED playback mode, you hear the green signal.</p>',
                },
                fsHr: {
                    t: 'Harmonics',
                    b: '<h3>Individual Harmonics</h3><p>Each row = one sine wave at k √ó fundamental freq. Color-coded by harmonic number.</p>',
                },
            };
            let lCol = false;
            function L(k) {
                const l = LS[k];
                if (!l) return;
                $('lT').textContent = l.t;
                $('lB').innerHTML = l.b;
                if (lCol) {
                    lCol = false;
                    $('lP').classList.remove('co');
                }
            }
            function togLP() {
                lCol = !lCol;
                $('lP').classList.toggle('co', lCol);
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // DSP
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function gW(t, sz) {
                const w = new Float64Array(sz);
                for (let n = 0; n < sz; n++) {
                    switch (t) {
                        case 'rectangular':
                            w[n] = 1;
                            break;
                        case 'hann':
                            w[n] =
                                0.5 *
                                (1 - Math.cos((2 * Math.PI * n) / (sz - 1)));
                            break;
                        case 'hamming':
                            w[n] =
                                0.54 -
                                0.46 * Math.cos((2 * Math.PI * n) / (sz - 1));
                            break;
                        case 'blackman':
                            w[n] =
                                0.42 -
                                0.5 * Math.cos((2 * Math.PI * n) / (sz - 1)) +
                                0.08 * Math.cos((4 * Math.PI * n) / (sz - 1));
                            break;
                    }
                }
                return w;
            }
            function fI(re, im) {
                const n = re.length;
                if (n <= 1) return;
                for (let i = 1, j = 0; i < n; i++) {
                    let b = n >> 1;
                    for (; j & b; b >>= 1) j ^= b;
                    j ^= b;
                    if (i < j) {
                        [re[i], re[j]] = [re[j], re[i]];
                        [im[i], im[j]] = [im[j], im[i]];
                    }
                }
                for (let l = 2; l <= n; l <<= 1) {
                    const a = (-2 * Math.PI) / l,
                        wR = Math.cos(a),
                        wI = Math.sin(a);
                    for (let i = 0; i < n; i += l) {
                        let cR = 1,
                            cI = 0;
                        for (let j = 0; j < l / 2; j++) {
                            const uR = re[i + j],
                                uI = im[i + j],
                                vR =
                                    re[i + j + l / 2] * cR -
                                    im[i + j + l / 2] * cI,
                                vI =
                                    re[i + j + l / 2] * cI +
                                    im[i + j + l / 2] * cR;
                            re[i + j] = uR + vR;
                            im[i + j] = uI + vI;
                            re[i + j + l / 2] = uR - vR;
                            im[i + j + l / 2] = uI - vI;
                            const nR = cR * wR - cI * wI;
                            cI = cR * wI + cI * wR;
                            cR = nR;
                        }
                    }
                }
            }
            function ifI(re, im) {
                const n = re.length;
                for (let i = 0; i < n; i++) im[i] = -im[i];
                fI(re, im);
                for (let i = 0; i < n; i++) {
                    re[i] /= n;
                    im[i] = -im[i] / n;
                }
            }

            function fftSlice(sig, st, sz, wt, zp) {
                let n = 1;
                while (n < sz * zp) n <<= 1;
                const w = gW(wt, sz),
                    re = new Float64Array(n),
                    im = new Float64Array(n);
                for (let i = 0; i < sz; i++) {
                    const idx = st + i;
                    if (idx >= 0 && idx < sig.length) re[i] = sig[idx] * w[i];
                }
                fI(re, im);
                const h = n / 2 + 1,
                    m = new Float64Array(h);
                for (let i = 0; i < h; i++)
                    m[i] = Math.sqrt(re[i] * re[i] + im[i] * im[i]);
                return { mag: m, n };
            }
            function fullFFT(sig, wt, sr, zp) {
                let n = 1;
                while (n < sig.length * zp) n <<= 1;
                const w = gW(wt, sig.length),
                    re = new Float64Array(n),
                    im = new Float64Array(n);
                for (let i = 0; i < sig.length; i++) re[i] = sig[i] * w[i];
                fI(re, im);
                const h = n / 2 + 1,
                    m = new Float64Array(h),
                    f = new Float64Array(h);
                for (let i = 0; i < h; i++) {
                    m[i] = Math.sqrt(re[i] * re[i] + im[i] * im[i]);
                    f[i] = (i * sr) / n;
                }
                return { mag: m, freqs: f, n };
            }
            function compSTFT(sig, nf, hp, wt, zp) {
                const w = gW(wt, nf);
                let fs = 1;
                while (fs < nf * zp) fs <<= 1;
                const nfr = Math.max(1, Math.floor((sig.length - nf) / hp) + 1),
                    nb = fs / 2 + 1,
                    sp = [];
                for (let f = 0; f < nfr; f++) {
                    const s = f * hp,
                        re = new Float64Array(fs),
                        im = new Float64Array(fs);
                    for (let i = 0; i < nf && s + i < sig.length; i++)
                        re[i] = sig[s + i] * w[i];
                    fI(re, im);
                    const m = new Float64Array(nb);
                    for (let i = 0; i < nb; i++)
                        m[i] = Math.sqrt(re[i] * re[i] + im[i] * im[i]);
                    sp.push(m);
                }
                return { spec: sp, numBins: nb, numFrames: nfr, fftSize: fs };
            }

            // ‚îÄ‚îÄ BANDPASS FILTER via FFT ‚îÄ‚îÄ
            function bandpassFilter(sig, sr, loHz, hiHz) {
                let n = 1;
                while (n < sig.length) n <<= 1;
                const re = new Float64Array(n),
                    im = new Float64Array(n);
                for (let i = 0; i < sig.length; i++) re[i] = sig[i];
                fI(re, im);
                const binLo = Math.floor((loHz * n) / sr),
                    binHi = Math.ceil((hiHz * n) / sr);
                for (let i = 0; i < n; i++) {
                    if (i <= n / 2) {
                        if (i < binLo || i > binHi) {
                            re[i] = 0;
                            im[i] = 0;
                        }
                    } else {
                        const mirror = n - i;
                        if (mirror < binLo || mirror > binHi) {
                            re[i] = 0;
                            im[i] = 0;
                        }
                    }
                }
                ifI(re, im);
                const out = new Float64Array(sig.length);
                for (let i = 0; i < sig.length; i++) out[i] = re[i];
                return out;
            }

            // ‚îÄ‚îÄ Fourier Series ‚îÄ‚îÄ
            function compFS(sig, st, ws) {
                const chunk = new Float64Array(ws);
                for (let i = 0; i < ws; i++) {
                    const idx = st + i;
                    chunk[i] = idx >= 0 && idx < sig.length ? sig[idx] : 0;
                }
                let n = 1;
                while (n < ws) n <<= 1;
                const re = new Float64Array(n),
                    im = new Float64Array(n);
                for (let i = 0; i < ws; i++) re[i] = chunk[i];
                fI(re, im);
                const mH = Math.min(Math.floor(ws / 2), 256),
                    h = [];
                for (let k = 0; k <= mH; k++) {
                    const amp =
                        k === 0
                            ? Math.sqrt(re[0] * re[0] + im[0] * im[0]) / ws
                            : (2 * Math.sqrt(re[k] * re[k] + im[k] * im[k])) /
                              ws;
                    h.push({ k, amp, phase: Math.atan2(im[k], re[k]) });
                }
                // Build reconstruction audio for playback
                return { harmonics: h, chunk, re, im, n: n };
            }

            function reconstructFS(harmonics, ws, numH) {
                const out = new Float64Array(ws);
                for (let k = 0; k <= numH && k < harmonics.length; k++) {
                    const h = harmonics[k];
                    for (let i = 0; i < ws; i++) {
                        const t = i / ws;
                        out[i] +=
                            k === 0
                                ? h.amp * Math.cos(h.phase)
                                : h.amp *
                                  Math.cos(2 * Math.PI * k * t + h.phase);
                    }
                }
                return out;
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // GENERATORS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function gTones(fs, d) {
                const N = Math.floor(fs * d),
                    s = new Float64Array(N);
                for (let i = 0; i < N; i++) {
                    const t = i / fs;
                    s[i] =
                        0.7 * Math.sin(2 * Math.PI * 440 * t) +
                        0.5 * Math.sin(2 * Math.PI * 1e3 * t) +
                        0.3 * Math.sin(2 * Math.PI * 2500 * t) +
                        0.05 * (Math.random() * 2 - 1);
                }
                return s;
            }
            function gChirp(fs, d) {
                const N = Math.floor(fs * d),
                    s = new Float64Array(N);
                for (let i = 0; i < N; i++) {
                    const t = i / fs;
                    s[i] =
                        0.8 *
                        Math.sin(
                            2 * Math.PI * (100 * t + (0.5 * 3900 * t * t) / d),
                        );
                }
                return s;
            }
            function gImp(fs, d) {
                const N = Math.floor(fs * d),
                    s = new Float64Array(N),
                    iv = Math.floor(fs * 0.35);
                for (let i = 0; i < N; i++) {
                    const m = i % iv;
                    if (m < Math.floor(fs * 0.012))
                        s[i] = 0.9 * Math.exp(-m / (fs * 0.003));
                }
                return s;
            }
            function gChord(fs, d) {
                const f = [261.63, 329.63, 392, 523.25, 659.25, 784],
                    a = [0.5, 0.4, 0.45, 0.25, 0.2, 0.22],
                    N = Math.floor(fs * d),
                    s = new Float64Array(N);
                for (let i = 0; i < N; i++) {
                    const t = i / fs;
                    for (let j = 0; j < f.length; j++)
                        s[i] += a[j] * Math.sin(2 * Math.PI * f[j] * t);
                    s[i] += 0.03 * (Math.random() * 2 - 1);
                }
                return s;
            }
            function gSq(fs, d) {
                const N = Math.floor(fs * d),
                    s = new Float64Array(N);
                for (let i = 0; i < N; i++)
                    s[i] =
                        Math.sin((2 * Math.PI * 200 * i) / fs) >= 0
                            ? 0.8
                            : -0.8;
                return s;
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // COLORMAP
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const MG = [
                [0, 0, 4],
                [1, 0, 11],
                [3, 1, 22],
                [7, 2, 36],
                [14, 4, 52],
                [24, 6, 68],
                [38, 9, 82],
                [53, 12, 90],
                [68, 15, 94],
                [84, 18, 96],
                [100, 22, 96],
                [116, 25, 93],
                [132, 29, 89],
                [149, 33, 84],
                [165, 38, 79],
                [181, 44, 73],
                [196, 51, 67],
                [210, 60, 60],
                [222, 72, 53],
                [232, 86, 46],
                [240, 101, 39],
                [246, 118, 33],
                [250, 136, 29],
                [252, 155, 27],
                [252, 174, 30],
                [250, 194, 39],
                [247, 214, 55],
                [244, 233, 79],
                [245, 249, 107],
                [252, 253, 191],
            ];
            function mc(v) {
                const t = Math.max(0, Math.min(1, v)),
                    i = t * (MG.length - 1),
                    l = Math.floor(i),
                    h = Math.min(l + 1, MG.length - 1),
                    f = i - l;
                return [
                    Math.round(MG[l][0] + (MG[h][0] - MG[l][0]) * f),
                    Math.round(MG[l][1] + (MG[h][1] - MG[l][1]) * f),
                    Math.round(MG[l][2] + (MG[h][2] - MG[l][2]) * f),
                ];
            }
            const HC = [
                '#f87171',
                '#fb923c',
                '#fbbf24',
                '#a3e635',
                '#34d399',
                '#22d3ee',
                '#60a5fa',
                '#a78bfa',
                '#e879f9',
                '#fb7185',
                '#f97316',
                '#facc15',
                '#4ade80',
                '#2dd4bf',
                '#38bdf8',
                '#818cf8',
                '#c084fc',
            ];

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // STATE
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const S = {
                sig: null,
                sr: 44100,
                lbl: '',
                preset: 'tones',
                tab: 'fft',
                wt: 'hann',
                mf: 8e3,
                nfft: 1024,
                olP: 75,
                zpR: 1,
                dynR: 60,
                anOn: true,
                playing: false,
                pSt: 0,
                pOff: 0,
                dur: 0,
                aCtx: null,
                sN: null,
                aBuf: null,
                aF: null,
                stD: null,
                fsW: 512,
                fsH: 8,
                fsOff: 0,
                bLo: 0,
                bHi: 22050,
                extSig: null,
                extBuf: null,
                playExt: false,
                showOv: true,
                fsSig: null,
                fsBuf: null,
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // EXTRACTION
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function recomputeExtraction() {
                if (!S.sig) return;
                if (S.tab === 'fs') {
                    // FS reconstruction for playback
                    const off = Math.floor(
                        (S.fsOff / 1000) * Math.max(0, S.sig.length - S.fsW),
                    );
                    const { harmonics, chunk } = compFS(S.sig, off, S.fsW);
                    const recon = reconstructFS(harmonics, S.fsW, S.fsH);
                    // Tile reconstruction to signal length
                    const out = new Float64Array(S.sig.length);
                    for (let i = 0; i < out.length; i++)
                        out[i] = recon[i % S.fsW];
                    S.fsSig = out;
                    S.fsBuf = null;
                } else {
                    S.extSig = bandpassFilter(S.sig, S.sr, S.bLo, S.bHi);
                    S.extBuf = null;
                }
            }

            function getPlaySig() {
                if (!S.playExt) return S.sig;
                if (S.tab === 'fs') return S.fsSig || S.sig;
                return S.extSig || S.sig;
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // AUDIO
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function ensCtx() {
                if (!S.aCtx)
                    S.aCtx = new (
                        window.AudioContext || window.webkitAudioContext
                    )();
                if (S.aCtx.state === 'suspended') S.aCtx.resume();
                return S.aCtx;
            }
            function buildBuf(sig) {
                const c = ensCtx(),
                    b = c.createBuffer(1, sig.length, S.sr),
                    ch = b.getChannelData(0);
                for (let i = 0; i < sig.length; i++)
                    ch[i] = Math.max(-1, Math.min(1, sig[i]));
                return b;
            }

            function togPlay() {
                S.playing ? pauseA() : startA();
            }
            function startA() {
                if (!S.sig || !S.sig.length) return;
                ensCtx();
                const ps = getPlaySig();
                if (!ps) return;
                const buf = buildBuf(ps);
                if (S.pOff >= S.dur - 0.01) S.pOff = 0;
                const s = S.aCtx.createBufferSource();
                s.buffer = buf;
                s.connect(S.aCtx.destination);
                s.onended = () => {
                    if (S.playing) {
                        S.playing = false;
                        S.pOff = S.dur;
                        updTr();
                        stopAL();
                    }
                };
                s.start(0, S.pOff);
                S.sN = s;
                S.pSt = S.aCtx.currentTime;
                S.playing = true;
                S.dur = ps.length / S.sr;
                updTr();
                startAL();
            }
            function pauseA() {
                if (!S.playing) return;
                S.pOff = curT();
                if (S.sN) {
                    try {
                        S.sN.stop();
                    } catch (e) {}
                    S.sN = null;
                }
                S.playing = false;
                updTr();
                stopAL();
                rFr();
            }
            function stopA() {
                if (S.sN) {
                    try {
                        S.sN.stop();
                    } catch (e) {}
                    S.sN = null;
                }
                S.playing = false;
                S.pOff = 0;
                updTr();
                stopAL();
                rAll();
            }
            function curT() {
                if (!S.playing) return S.pOff;
                return Math.min(S.pOff + S.aCtx.currentTime - S.pSt, S.dur);
            }
            function seekTo(f) {
                const w = S.playing;
                if (w) {
                    if (S.sN) {
                        try {
                            S.sN.stop();
                        } catch (e) {}
                        S.sN = null;
                    }
                    S.playing = false;
                }
                S.pOff = f * S.dur;
                w ? startA() : (updTr(), rFr());
            }
            function fmtT(s) {
                const m = Math.floor(s / 60),
                    sc = s - m * 60;
                return m + ':' + sc.toFixed(1).padStart(4, '0');
            }
            function updTr() {
                const b = $('playB');
                b.textContent = S.playing ? '‚è∏' : '‚ñ∂';
                b.classList.toggle('pl', S.playing && !S.playExt);
                b.classList.toggle('ext', S.playing && S.playExt);
                $('livB').style.display = S.playing ? '' : 'none';
                $('livS').style.display =
                    S.playing && S.anOn && S.tab !== 'fs' ? '' : 'none';
            }

            function togExtPlay() {
                const was = S.playing;
                if (was) pauseA();
                S.playExt = !S.playExt;
                $('extPlayB').textContent = S.playExt
                    ? 'EXTRACTED'
                    : 'ORIGINAL';
                $('extPlayB').classList.toggle('ext', S.playExt);
                if (was) startA();
            }

            function togOverlay() {
                S.showOv = !S.showOv;
                $('ovTog').classList.toggle('on', S.showOv);
                if (!S.playing) rAll();
            }
            function togAn() {
                S.anOn = !S.anOn;
                $('anTog').classList.toggle('on', S.anOn);
                $('livS').style.display =
                    S.playing && S.anOn && S.tab !== 'fs' ? '' : 'none';
                if (!S.playing) rAll();
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ANIMATION
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function startAL() {
                function lp() {
                    if (!S.playing) return;
                    rFr();
                    S.aF = requestAnimationFrame(lp);
                }
                S.aF = requestAnimationFrame(lp);
            }
            function stopAL() {
                if (S.aF) {
                    cancelAnimationFrame(S.aF);
                    S.aF = null;
                }
            }
            function rFr() {
                const t = curT(),
                    f = S.dur > 0 ? t / S.dur : 0;
                $('seek').value = Math.round(f * 1000);
                $('tDisp').textContent = fmtT(t) + ' / ' + fmtT(S.dur);
                dWave(f);
                if (S.tab === 'fs') dFS();
                else if (S.anOn) {
                    S.tab === 'fft' ? dFFT(f) : dSTFT(f);
                    if (S.playing) dLive(t);
                } else dOff();
            }
            function rAll() {
                const f = S.dur > 0 ? S.pOff / S.dur : 0;
                $('seek').value = Math.round(f * 1000);
                $('tDisp').textContent = fmtT(S.pOff) + ' / ' + fmtT(S.dur);
                dWave(f);
                if (S.tab === 'fs') dFS();
                else if (S.anOn) {
                    S.tab === 'fft' ? dFFT(f) : dSTFT(f);
                } else dOff();
                $('livS').style.display =
                    S.playing && S.anOn && S.tab !== 'fs' ? '' : 'none';
                updP();
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // DRAWING
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function gC(id, h) {
                const c = $(id),
                    dp = devicePixelRatio || 1,
                    r = c.parentElement.getBoundingClientRect(),
                    W = r.width;
                c.width = W * dp;
                c.height = h * dp;
                c.style.height = h + 'px';
                const cx = c.getContext('2d');
                cx.scale(dp, dp);
                return { cx, W, H: h };
            }

            function dWave(pf) {
                const { cx, W, H } = gC('wC', 110);
                cx.fillStyle = '#0a0a0f';
                cx.fillRect(0, 0, W, H);
                if (!S.sig) return;
                const sig = S.sig;
                // FS window highlight
                if (S.tab === 'fs') {
                    const off = Math.floor(
                        (S.fsOff / 1000) * Math.max(0, sig.length - S.fsW),
                    );
                    const x0 = (off / sig.length) * W,
                        x1 = ((off + S.fsW) / sig.length) * W;
                    cx.fillStyle = 'rgba(251,191,36,.08)';
                    cx.fillRect(x0, 0, x1 - x0, H);
                    cx.strokeStyle = 'rgba(251,191,36,.3)';
                    cx.lineWidth = 1;
                    cx.strokeRect(x0, 0, x1 - x0, H);
                }
                // Original waveform
                cx.beginPath();
                cx.strokeStyle = '#3b82f6';
                cx.lineWidth = 0.7;
                const step = Math.max(1, Math.floor(sig.length / W));
                for (let px = 0; px < W; px++) {
                    const idx = Math.floor((px / W) * sig.length);
                    let mn = 1e9,
                        mx = -1e9;
                    for (let j = 0; j < step && idx + j < sig.length; j++) {
                        mn = Math.min(mn, sig[idx + j]);
                        mx = Math.max(mx, sig[idx + j]);
                    }
                    const y1 = H / 2 - mx * H * 0.44,
                        y2 = H / 2 - mn * H * 0.44;
                    px === 0 ? cx.moveTo(px, y1) : 0;
                    cx.lineTo(px, y1);
                    cx.lineTo(px, y2);
                }
                cx.stroke();
                // Extraction overlay
                const ext = S.tab === 'fs' ? S.fsSig : S.extSig;
                if (S.showOv && ext && ext.length === sig.length) {
                    cx.beginPath();
                    cx.strokeStyle = 'rgba(34,211,238,.65)';
                    cx.lineWidth = 0.9;
                    for (let px = 0; px < W; px++) {
                        const idx = Math.floor((px / W) * ext.length);
                        let mn = 1e9,
                            mx = -1e9;
                        for (let j = 0; j < step && idx + j < ext.length; j++) {
                            mn = Math.min(mn, ext[idx + j]);
                            mx = Math.max(mx, ext[idx + j]);
                        }
                        const y1 = H / 2 - mx * H * 0.44,
                            y2 = H / 2 - mn * H * 0.44;
                        px === 0 ? cx.moveTo(px, y1) : 0;
                        cx.lineTo(px, y1);
                        cx.lineTo(px, y2);
                    }
                    cx.stroke();
                }
                // Center line
                cx.strokeStyle = 'rgba(255,255,255,.05)';
                cx.lineWidth = 0.5;
                cx.beginPath();
                cx.moveTo(0, H / 2);
                cx.lineTo(W, H / 2);
                cx.stroke();
                // Playhead
                if (pf >= 0 && S.tab !== 'fs') {
                    const x = pf * W;
                    cx.strokeStyle = S.playing
                        ? S.playExt
                            ? '#22d3ee'
                            : '#34d399'
                        : 'rgba(167,139,250,.6)';
                    cx.lineWidth = S.playing ? 2 : 1.5;
                    cx.beginPath();
                    cx.moveTo(x, 0);
                    cx.lineTo(x, H);
                    cx.stroke();
                }
                // Legend
                cx.font = '9px "DM Mono",monospace';
                cx.textAlign = 'left';
                cx.fillStyle = '#3b82f6';
                cx.fillText('‚ñ† original', 6, H - 4);
                if (S.showOv && ext) {
                    cx.fillStyle = '#22d3ee';
                    cx.fillText('‚ñ† extracted', 70, H - 4);
                }
                $('wCap').textContent =
                    `${S.lbl} ¬∑ ${sig.length.toLocaleString()} ¬∑ ${S.sr} Hz ¬∑ ${(sig.length / S.sr).toFixed(2)}s`;
            }

            function dFFT(pf) {
                $('anOff').style.display = 'none';
                const { cx, W, H } = gC('mC', 280);
                cx.fillStyle = '#0a0a0f';
                cx.fillRect(0, 0, W, H);
                if (!S.sig) return;
                let mag, freqs, n;
                if (pf > 0 && pf < 1) {
                    const c = Math.floor(pf * S.sig.length),
                        st = Math.max(0, c - Math.floor(S.nfft / 2));
                    const r = fftSlice(S.sig, st, S.nfft, S.wt, S.zpR);
                    mag = r.mag;
                    n = r.n;
                    freqs = new Float64Array(mag.length);
                    for (let i = 0; i < mag.length; i++)
                        freqs[i] = (i * S.sr) / n;
                } else {
                    const r = fullFFT(S.sig, S.wt, S.sr, S.zpR);
                    mag = r.mag;
                    freqs = r.freqs;
                    n = r.n;
                }
                const dm = Math.min(S.mf, S.sr / 2);
                let mxD = -1e9;
                const mD = [];
                for (let i = 0; i < mag.length; i++) {
                    const d = 20 * Math.log10(mag[i] + 1e-10);
                    if (d > mxD) mxD = d;
                    mD.push(d);
                }
                const mnD = mxD - S.dynR;
                const p = { l: 48, r: 12, t: 12, b: 30 },
                    pW = W - p.l - p.r,
                    pH = H - p.t - p.b;
                // Band highlight
                const bx0 = p.l + (S.bLo / dm) * pW,
                    bx1 = p.l + (Math.min(S.bHi, dm) / dm) * pW;
                cx.fillStyle = 'rgba(34,211,238,.06)';
                cx.fillRect(
                    Math.max(bx0, p.l),
                    p.t,
                    Math.min(bx1, p.l + pW) - Math.max(bx0, p.l),
                    pH,
                );
                cx.strokeStyle = 'rgba(34,211,238,.3)';
                cx.lineWidth = 1;
                cx.setLineDash([4, 4]);
                if (S.bLo > 0 && S.bLo <= dm) {
                    cx.beginPath();
                    cx.moveTo(bx0, p.t);
                    cx.lineTo(bx0, p.t + pH);
                    cx.stroke();
                }
                if (S.bHi < dm) {
                    cx.beginPath();
                    cx.moveTo(bx1, p.t);
                    cx.lineTo(bx1, p.t + pH);
                    cx.stroke();
                }
                cx.setLineDash([]);
                // Grid
                cx.strokeStyle = 'rgba(255,255,255,.04)';
                cx.lineWidth = 0.5;
                for (let f = 0; f <= dm; f += dm > 4e3 ? 1e3 : 500) {
                    const x = p.l + (f / dm) * pW;
                    cx.beginPath();
                    cx.moveTo(x, p.t);
                    cx.lineTo(x, p.t + pH);
                    cx.stroke();
                }
                // FFT
                cx.beginPath();
                cx.strokeStyle = '#a78bfa';
                cx.lineWidth = 1;
                for (let i = 0; i < mag.length; i++) {
                    if (freqs[i] > dm) break;
                    const x = p.l + (freqs[i] / dm) * pW,
                        nm = Math.max(0, (mD[i] - mnD) / (mxD - mnD)),
                        y = p.t + pH - nm * pH;
                    i === 0 ? cx.moveTo(x, y) : cx.lineTo(x, y);
                }
                cx.stroke();
                // Axis
                cx.fillStyle = 'rgba(255,255,255,.3)';
                cx.font = '9px "DM Mono",monospace';
                cx.textAlign = 'center';
                for (let f = 0; f <= dm; f += dm > 4e3 ? 2e3 : 1e3)
                    cx.fillText(f + '', p.l + (f / dm) * pW, H - 6);
                cx.textAlign = 'right';
                cx.fillText(mxD.toFixed(0) + 'dB', p.l - 3, p.t + 10);
                // Band labels
                cx.fillStyle = 'rgba(34,211,238,.5)';
                cx.font = '9px "DM Mono",monospace';
                cx.textAlign = 'center';
                const bcx = (Math.max(bx0, p.l) + Math.min(bx1, p.l + pW)) / 2;
                cx.fillText(
                    `extracted: ${S.bLo}-${Math.min(S.bHi, Math.floor(dm))} Hz`,
                    bcx,
                    p.t + 12,
                );
            }

            let sIC = null,
                sCK = '';
            function dSTFT(pf) {
                $('anOff').style.display = 'none';
                const { cx, W, H } = gC('mC', 300);
                cx.fillStyle = '#0a0a0f';
                cx.fillRect(0, 0, W, H);
                if (!S.sig) return;
                const hp = Math.max(1, Math.floor(S.nfft * (1 - S.olP / 100))),
                    ck = `${S.sig.length}_${S.nfft}_${hp}_${S.wt}_${S.mf}_${S.dynR}_${S.zpR}_${W}_${H}`;
                const p = { l: 42, r: 8, t: 8, b: 26 },
                    pW = W - p.l - p.r,
                    pH = H - p.t - p.b,
                    dp = devicePixelRatio || 1;
                if (sCK !== ck) {
                    const { spec, numBins, numFrames, fftSize } = compSTFT(
                        S.sig,
                        S.nfft,
                        hp,
                        S.wt,
                        S.zpR,
                    );
                    S.stD = { spec, numBins, numFrames, fftSize, hop: hp };
                    const ny = S.sr / 2,
                        dm = Math.min(S.mf, ny),
                        mbi = Math.floor((dm / ny) * (numBins - 1));
                    let gM = -1e9;
                    const db = spec.map(f =>
                        f.map(v => {
                            const d = 20 * Math.log10(v + 1e-10);
                            if (d > gM) gM = d;
                            return d;
                        }),
                    );
                    const gm = gM - S.dynR;
                    const iW = Math.ceil(pW * dp),
                        iH = Math.ceil(pH * dp),
                        id = cx.createImageData(iW, iH);
                    for (let px = 0; px < iW; px++) {
                        const fi = Math.min(
                                Math.floor((px / iW) * numFrames),
                                numFrames - 1,
                            ),
                            fr = db[fi];
                        for (let py = 0; py < iH; py++) {
                            const bi = Math.min(
                                    Math.floor(((iH - py) / iH) * mbi),
                                    numBins - 1,
                                ),
                                v = (fr[bi] - gm) / S.dynR;
                            const [r, g, b] = mc(v);
                            const i = (py * iW + px) * 4;
                            id.data[i] = r;
                            id.data[i + 1] = g;
                            id.data[i + 2] = b;
                            id.data[i + 3] = 255;
                        }
                    }
                    sIC = id;
                    sCK = ck;
                }
                if (sIC) cx.putImageData(sIC, p.l * dp, p.t * dp);
                // Band overlay
                const ny = S.sr / 2,
                    dm = Math.min(S.mf, ny);
                const by0 = p.t + pH - (Math.min(S.bHi, dm) / dm) * pH,
                    by1 = p.t + pH - (S.bLo / dm) * pH;
                cx.fillStyle = 'rgba(34,211,238,.1)';
                cx.fillRect(
                    p.l,
                    Math.max(by0, p.t),
                    pW,
                    Math.min(by1, p.t + pH) - Math.max(by0, p.t),
                );
                cx.strokeStyle = 'rgba(34,211,238,.4)';
                cx.lineWidth = 1;
                cx.setLineDash([4, 3]);
                if (S.bLo > 0) {
                    cx.beginPath();
                    cx.moveTo(p.l, by1);
                    cx.lineTo(p.l + pW, by1);
                    cx.stroke();
                }
                if (S.bHi < dm) {
                    cx.beginPath();
                    cx.moveTo(p.l, by0);
                    cx.lineTo(p.l + pW, by0);
                    cx.stroke();
                }
                cx.setLineDash([]);
                // Playhead
                if (pf >= 0) {
                    const x = p.l + pf * pW;
                    cx.strokeStyle = S.playing
                        ? S.playExt
                            ? '#22d3ee'
                            : '#34d399'
                        : 'rgba(167,139,250,.6)';
                    cx.lineWidth = S.playing ? 2 : 1.5;
                    cx.beginPath();
                    cx.moveTo(x, p.t);
                    cx.lineTo(x, p.t + pH);
                    cx.stroke();
                }
                // Axis
                cx.fillStyle = 'rgba(255,255,255,.3)';
                cx.font = '9px "DM Mono",monospace';
                cx.textAlign = 'right';
                for (let f = 0; f <= dm; f += dm > 4e3 ? 2e3 : 1e3) {
                    const y = p.t + pH - (f / dm) * pH;
                    cx.fillText(f + '', p.l - 3, y + 3);
                }
                cx.textAlign = 'center';
                const dur = S.sig.length / S.sr;
                for (
                    let s = 0;
                    s <= dur;
                    s += dur > 3 ? 1 : dur > 1 ? 0.5 : 0.2
                ) {
                    const x = p.l + (s / dur) * pW;
                    cx.fillText(s.toFixed(1) + 's', x, H - 4);
                }
            }

            function dLive(ct) {
                if (!S.sig || !S.anOn) return;
                const { cx, W, H } = gC('livC', 150);
                cx.fillStyle = '#0a0a0f';
                cx.fillRect(0, 0, W, H);
                const c = Math.floor((ct / S.dur) * S.sig.length),
                    st = Math.max(0, c - Math.floor(S.nfft / 2));
                const { mag, n } = fftSlice(S.sig, st, S.nfft, S.wt, S.zpR);
                const dm = Math.min(S.mf, S.sr / 2);
                let mxD = -1e9;
                const mD = [];
                for (let i = 0; i < mag.length; i++) {
                    const d = 20 * Math.log10(mag[i] + 1e-10);
                    if (d > mxD) mxD = d;
                    mD.push(d);
                }
                const mnD = mxD - S.dynR;
                const p = { l: 42, r: 8, t: 8, b: 22 },
                    pW = W - p.l - p.r,
                    pH = H - p.t - p.b;
                const nb = Math.floor((dm / (S.sr / 2)) * mag.length),
                    bW = Math.max(1, pW / nb);
                for (let i = 0; i < nb && i < mag.length; i++) {
                    const nm = Math.max(0, (mD[i] - mnD) / (mxD - mnD)),
                        x = p.l + (i / nb) * pW,
                        bH = nm * pH;
                    const freq = (i * S.sr) / n;
                    const inBand = freq >= S.bLo && freq <= S.bHi;
                    if (inBand) {
                        cx.fillStyle = `rgba(34,211,238,${0.4 + nm * 0.6})`;
                    } else {
                        const h = 260 - nm * 80;
                        cx.fillStyle = `hsla(${h},50%,${40 + nm * 15}%,${0.3 + nm * 0.3})`;
                    }
                    cx.fillRect(x, p.t + pH - bH, Math.max(bW - 0.5, 0.5), bH);
                }
            }

            function dOff() {
                const { cx, W, H } = gC('mC', S.tab === 'stft' ? 300 : 280);
                cx.fillStyle = '#0a0a0f';
                cx.fillRect(0, 0, W, H);
                $('anOff').style.display = '';
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FOURIER SERIES
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function dFS() {
                $('anOff').style.display = 'none';
                if (!S.sig) return;
                const off = Math.floor(
                    (S.fsOff / 1000) * Math.max(0, S.sig.length - S.fsW),
                );
                const { harmonics, chunk } = compFS(S.sig, off, S.fsW);
                const numH = Math.min(S.fsH, harmonics.length - 1);
                // Main: tiled window
                const { cx, W, H } = gC('mC', 200);
                cx.fillStyle = '#0a0a0f';
                cx.fillRect(0, 0, W, H);
                const p = { l: 6, r: 6, t: 12, b: 18 },
                    pW = W - p.l - p.r,
                    pH = H - p.t - p.b;
                let mn = 1e9,
                    mx = -1e9;
                for (let i = 0; i < chunk.length; i++) {
                    if (chunk[i] < mn) mn = chunk[i];
                    if (chunk[i] > mx) mx = chunk[i];
                }
                const amp = Math.max(Math.abs(mn), Math.abs(mx), 0.001);
                for (let cp = -1; cp <= 1; cp++) {
                    const xO = p.l + ((cp + 1) / 3) * pW,
                        sW = pW / 3;
                    cx.strokeStyle =
                        cp === 0
                            ? 'rgba(255,255,255,.6)'
                            : 'rgba(255,255,255,.12)';
                    cx.lineWidth = cp === 0 ? 1.2 : 0.5;
                    if (cp === 0) {
                        cx.fillStyle = 'rgba(255,255,255,.02)';
                        cx.fillRect(xO, p.t, sW, pH);
                    }
                    cx.beginPath();
                    for (let i = 0; i < chunk.length; i++) {
                        const x = xO + (i / chunk.length) * sW,
                            y = p.t + pH / 2 - (chunk[i] / amp) * pH * 0.42;
                        i === 0 ? cx.moveTo(x, y) : cx.lineTo(x, y);
                    }
                    cx.stroke();
                }
                cx.fillStyle = 'rgba(251,191,36,.4)';
                cx.font = '10px "DM Mono",monospace';
                cx.textAlign = 'center';
                cx.fillText(
                    `f‚ÇÅ = ${(S.sr / S.fsW).toFixed(1)} Hz ¬∑ Period = ${((S.fsW / S.sr) * 1e3).toFixed(1)} ms`,
                    W / 2,
                    p.t - 1,
                );

                // Recon
                const recon = reconstructFS(harmonics, S.fsW, numH);
                const { cx: rx, W: rW, H: rH } = gC('fsRC', 90);
                rx.fillStyle = '#0a0a0f';
                rx.fillRect(0, 0, rW, rH);
                const rp = { l: 6, r: 6, t: 6, b: 6 },
                    rpW = rW - rp.l - rp.r,
                    rpH = rH - rp.t - rp.b;
                rx.strokeStyle = 'rgba(255,255,255,.25)';
                rx.lineWidth = 1;
                rx.beginPath();
                for (let i = 0; i < chunk.length; i++) {
                    const x = rp.l + (i / chunk.length) * rpW,
                        y = rp.t + rpH / 2 - (chunk[i] / amp) * rpH * 0.42;
                    i === 0 ? rx.moveTo(x, y) : rx.lineTo(x, y);
                }
                rx.stroke();
                rx.strokeStyle = '#34d399';
                rx.lineWidth = 1.5;
                rx.beginPath();
                for (let i = 0; i < recon.length; i++) {
                    const x = rp.l + (i / recon.length) * rpW,
                        y = rp.t + rpH / 2 - (recon[i] / amp) * rpH * 0.42;
                    i === 0 ? rx.moveTo(x, y) : rx.lineTo(x, y);
                }
                rx.stroke();
                rx.font = '9px "DM Mono",monospace';
                rx.textAlign = 'left';
                rx.fillStyle = 'rgba(255,255,255,.3)';
                rx.fillText('white=original', 5, 12);
                rx.fillStyle = 'rgba(52,211,153,.7)';
                rx.fillText('green=reconstruction', 110, 12);
                $('fsRCap').textContent =
                    `${numH} harmonics of ${Math.floor(S.fsW / 2)} possible`;

                // Harmonics
                const sc = $('fsScr');
                const need = numH + 1;
                while (sc.children.length > need) sc.removeChild(sc.lastChild);
                while (sc.children.length < need) {
                    const r = document.createElement('div');
                    r.className = 'fhr';
                    const l = document.createElement('div');
                    l.className = 'fhl';
                    const c = document.createElement('canvas');
                    c.className = 'fhc';
                    c.height = 32;
                    r.appendChild(l);
                    r.appendChild(c);
                    sc.appendChild(r);
                }
                for (let k = 0; k <= numH; k++) {
                    const h = harmonics[k],
                        row = sc.children[k],
                        lbl = row.children[0],
                        cvs = row.children[1];
                    const freq =
                        k === 0
                            ? 'DC'
                            : `${((k * S.sr) / S.fsW).toFixed(0)} Hz`;
                    const col = HC[k % HC.length];
                    lbl.innerHTML = `<strong>k=${k}</strong> ${freq}<br><span style="font-size:8px;color:${col}">amp ${h.amp.toFixed(3)}</span>`;
                    const dp = devicePixelRatio || 1,
                        cW = Math.max(
                            100,
                            cvs.parentElement.getBoundingClientRect().width -
                                110,
                        );
                    cvs.style.width = cW + 'px';
                    cvs.width = cW * dp;
                    cvs.height = 32 * dp;
                    const cc = cvs.getContext('2d');
                    cc.scale(dp, dp);
                    cc.fillStyle = 'rgba(0,0,0,.3)';
                    cc.fillRect(0, 0, cW, 32);
                    cc.strokeStyle = 'rgba(255,255,255,.04)';
                    cc.lineWidth = 0.5;
                    cc.beginPath();
                    cc.moveTo(0, 16);
                    cc.lineTo(cW, 16);
                    cc.stroke();
                    cc.strokeStyle = col;
                    cc.lineWidth = 1.2;
                    cc.beginPath();
                    for (let i = 0; i < S.fsW; i++) {
                        const t = i / S.fsW,
                            x = (i / S.fsW) * cW;
                        const v =
                            k === 0
                                ? h.amp * Math.cos(h.phase)
                                : h.amp *
                                  Math.cos(2 * Math.PI * k * t + h.phase);
                        const y = 16 - (v / amp) * 14;
                        i === 0 ? cc.moveTo(x, y) : cc.lineTo(x, y);
                    }
                    cc.stroke();
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // PARAMS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function updP() {
                const g = $('pG'),
                    fs = S.sr,
                    ny = fs / 2;
                if (!S.sig) {
                    g.innerHTML = '';
                    return;
                }
                const hp = Math.max(1, Math.floor(S.nfft * (1 - S.olP / 100)));
                if (S.tab === 'fs') {
                    g.innerHTML =
                        pk('fs', fs.toLocaleString(), 'Hz', '', 'pfs') +
                        pk(
                            'Window',
                            S.fsW,
                            'samples',
                            ((S.fsW / fs) * 1e3).toFixed(1) + ' ms',
                            'fsW',
                        ) +
                        pk(
                            'f‚ÇÅ',
                            (fs / S.fsW).toFixed(1),
                            'Hz',
                            'fundamental',
                            'fsW',
                        ) +
                        pk(
                            'Harmonics',
                            S.fsH,
                            '',
                            'of ' + Math.floor(S.fsW / 2),
                            'fsH',
                        );
                } else if (S.tab === 'fft') {
                    let n = 1;
                    while (n < S.sig.length * S.zpR) n <<= 1;
                    g.innerHTML =
                        pk('fs', fs.toLocaleString(), 'Hz', '', 'pfs') +
                        pk('Nyquist', ny.toLocaleString(), 'Hz', '', 'pny') +
                        pk('N', S.sig.length.toLocaleString(), '', '', 'pN') +
                        pk('Œîf', (fs / n).toFixed(3), 'Hz', '', 'pdf') +
                        pk(
                            'Bins',
                            (n / 2 + 1).toLocaleString(),
                            '',
                            '',
                            'pbn',
                        ) +
                        pk(
                            'Band',
                            S.bLo + '-' + Math.min(S.bHi, Math.floor(ny)),
                            'Hz',
                            'extracted',
                            'bandSel',
                        );
                } else {
                    let fS = 1;
                    while (fS < S.nfft * S.zpR) fS <<= 1;
                    const nb = fS / 2 + 1,
                        nf = Math.max(
                            1,
                            Math.floor((S.sig.length - S.nfft) / hp) + 1,
                        );
                    g.innerHTML =
                        pk('fs', fs.toLocaleString(), 'Hz', '', 'pfs') +
                        pk(
                            'n_fft',
                            S.nfft,
                            '',
                            '' + ((S.nfft / fs) * 1e3).toFixed(1) + ' ms',
                            'nf',
                        ) +
                        pk('Hop', hp, '', '', 'ol') +
                        pk('Œîf', (fs / S.nfft).toFixed(1), 'Hz', '', 'pdf') +
                        pk(
                            'Œît',
                            ((hp / fs) * 1e3).toFixed(1),
                            'ms',
                            '',
                            'pdt',
                        ) +
                        pk('Shape', nb + '√ó' + nf, '', '', 'psh') +
                        pk(
                            'Band',
                            S.bLo + '-' + Math.min(S.bHi, Math.floor(ny)),
                            'Hz',
                            '',
                            'bandSel',
                        );
                }
            }
            function pk(l, v, u, d, lk) {
                return `<div class="pc" onclick="L('${lk}')"><div class="pl">${l}</div><div class="pv">${v}<span class="pu">${u}</span></div><div class="pd">${d}</div></div>`;
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // LOADING
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function ldP(p) {
                stopA();
                S.preset = p;
                const fs = 44100,
                    d = 2;
                S.sr = fs;
                switch (p) {
                    case 'tones':
                        S.sig = gTones(fs, d);
                        S.lbl = '440+1k+2.5k Hz';
                        break;
                    case 'chirp':
                        S.sig = gChirp(fs, d);
                        S.lbl = 'Chirp';
                        break;
                    case 'impulses':
                        S.sig = gImp(fs, d);
                        S.lbl = 'Impulses';
                        break;
                    case 'chord':
                        S.sig = gChord(fs, d);
                        S.lbl = 'C Major';
                        break;
                    case 'square':
                        S.sig = gSq(fs, d);
                        S.lbl = 'Square 200Hz';
                        break;
                }
                S.dur = d;
                S.pOff = 0;
                S.aBuf = null;
                sCK = '';
                document
                    .querySelectorAll('#pBtns .bt')
                    .forEach(b => b.classList.toggle('ac', b.dataset.p === p));
                $('uz').style.display = '';
                $('finfo').style.display = 'none';
                $('mfS').max = fs / 2;
                $('bandHi').max = fs / 2;
                $('bandLo').max = fs / 2;
                if (S.bHi > fs / 2) {
                    S.bHi = fs / 2;
                    $('bandHi').value = S.bHi;
                    $('bandHiV').textContent = S.bHi + ' Hz';
                }
                updFSMax();
                recomputeExtraction();
                rAll();
            }

            function ldFile(file) {
                const rd = new FileReader();
                rd.onload = function (e) {
                    try {
                        stopA();
                        const ctx = ensCtx();
                        ctx.decodeAudioData(
                            e.target.result,
                            function (buf) {
                                let mono;
                                if (buf.numberOfChannels > 1) {
                                    mono = new Float64Array(buf.length);
                                    for (
                                        let c = 0;
                                        c < buf.numberOfChannels;
                                        c++
                                    ) {
                                        const d = buf.getChannelData(c);
                                        for (let i = 0; i < mono.length; i++)
                                            mono[i] += d[i];
                                    }
                                    for (let i = 0; i < mono.length; i++)
                                        mono[i] /= buf.numberOfChannels;
                                } else {
                                    const r = buf.getChannelData(0);
                                    mono = new Float64Array(r.length);
                                    for (let i = 0; i < r.length; i++)
                                        mono[i] = r[i];
                                }
                                const mx = buf.sampleRate * 30;
                                S.sig =
                                    mono.length > mx ? mono.slice(0, mx) : mono;
                                S.sr = buf.sampleRate;
                                S.lbl = file.name;
                                S.dur = S.sig.length / S.sr;
                                S.pOff = 0;
                                S.aBuf = null;
                                sCK = '';
                                $('uz').style.display = 'none';
                                $('finfo').style.display = 'flex';
                                $('fname').textContent = file.name;
                                $('fmeta').textContent =
                                    `${buf.sampleRate} Hz ¬∑ ${buf.numberOfChannels}ch ¬∑ ${(buf.length / buf.sampleRate).toFixed(2)}s`;
                                document
                                    .querySelectorAll('#pBtns .bt')
                                    .forEach(b => b.classList.remove('ac'));
                                const ny = buf.sampleRate / 2;
                                $('mfS').max = ny;
                                $('bandHi').max = ny;
                                $('bandLo').max = ny;
                                if (S.mf > ny) {
                                    S.mf = Math.min(8e3, ny);
                                    $('mfS').value = S.mf;
                                    $('mfV').textContent = S.mf + ' Hz';
                                }
                                if (S.bHi > ny) {
                                    S.bHi = ny;
                                    $('bandHi').value = S.bHi;
                                    $('bandHiV').textContent = S.bHi + ' Hz';
                                }
                                updFSMax();
                                recomputeExtraction();
                                rAll();
                            },
                            function (err) {
                                alert('Decode error: ' + err.message);
                            },
                        );
                    } catch (err) {
                        alert(err.message);
                    }
                };
                rd.readAsArrayBuffer(file);
            }

            function updFSMax() {
                if (S.sig) {
                    const mx = Math.min(S.sig.length, 8192);
                    $('fsWS').max = mx;
                    if (S.fsW > mx) {
                        S.fsW = mx;
                        $('fsWS').value = mx;
                        $('fsWV').textContent = mx;
                    }
                    $('fsHS').max = Math.floor(S.fsW / 2);
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // EVENTS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            function init() {
                $('fin').addEventListener('change', e => {
                    if (e.target.files[0]) ldFile(e.target.files[0]);
                });
                const z = $('uz');
                z.addEventListener('dragover', e => {
                    e.preventDefault();
                    z.classList.add('dg');
                });
                z.addEventListener('dragleave', () => z.classList.remove('dg'));
                z.addEventListener('drop', e => {
                    e.preventDefault();
                    z.classList.remove('dg');
                    if (e.dataTransfer.files[0])
                        ldFile(e.dataTransfer.files[0]);
                });
                document.body.addEventListener('dragover', e =>
                    e.preventDefault(),
                );
                document.body.addEventListener('drop', e => {
                    e.preventDefault();
                    if (e.dataTransfer.files[0])
                        ldFile(e.dataTransfer.files[0]);
                });

                document.querySelectorAll('#pBtns .bt').forEach(b =>
                    b.addEventListener('click', () => {
                        ldP(b.dataset.p);
                        L('pre');
                    }),
                );

                document.querySelectorAll('.tab').forEach(t =>
                    t.addEventListener('click', () => {
                        S.tab = t.dataset.t;
                        document
                            .querySelectorAll('.tab')
                            .forEach(x => x.classList.toggle('ac', x === t));
                        const isFS = S.tab === 'fs';
                        $('fsCtrls').style.display = isFS ? 'none' : '';
                        $('fSerC').style.display = isFS ? '' : 'none';
                        $('fsViz').style.display = isFS ? '' : 'none';
                        $('stC').style.display = S.tab === 'stft' ? '' : 'none';
                        $('bandSec').style.display = isFS ? 'none' : '';
                        $('livS').style.display =
                            S.playing && S.anOn && !isFS ? '' : 'none';
                        sCK = '';
                        recomputeExtraction();
                        if (!S.playing) rAll();
                        else rFr();
                        updP();
                        L(t.dataset.l);
                    }),
                );

                document.querySelectorAll('#wBtns .bt').forEach(b =>
                    b.addEventListener('click', () => {
                        S.wt = b.dataset.w;
                        document
                            .querySelectorAll('#wBtns .bt')
                            .forEach(x => x.classList.toggle('ac', x === b));
                        sCK = '';
                        if (!S.playing) rAll();
                        L(b.dataset.l);
                    }),
                );
                document.querySelectorAll('#nfB .bt').forEach(b =>
                    b.addEventListener('click', () => {
                        S.nfft = parseInt(b.dataset.n);
                        document
                            .querySelectorAll('#nfB .bt')
                            .forEach(x => x.classList.toggle('ac', x === b));
                        sCK = '';
                        if (!S.playing) rAll();
                        updP();
                        L('nf');
                    }),
                );
                document.querySelectorAll('#zpB .bt').forEach(b =>
                    b.addEventListener('click', () => {
                        S.zpR = parseInt(b.dataset.z);
                        document
                            .querySelectorAll('#zpB .bt')
                            .forEach(x => x.classList.toggle('ac', x === b));
                        sCK = '';
                        if (!S.playing) rAll();
                        L('zp');
                    }),
                );

                $('mfS').addEventListener('input', e => {
                    S.mf = +e.target.value;
                    $('mfV').textContent = S.mf + ' Hz';
                    sCK = '';
                    if (!S.playing) rAll();
                });
                $('drS').addEventListener('input', e => {
                    S.dynR = +e.target.value;
                    $('drV').textContent = S.dynR + ' dB';
                    sCK = '';
                    if (!S.playing) rAll();
                });
                $('olS').addEventListener('input', e => {
                    S.olP = +e.target.value;
                    $('olV').textContent = S.olP + '%';
                    sCK = '';
                    if (!S.playing) rAll();
                    updP();
                });

                // Band sliders
                $('bandLo').addEventListener('input', e => {
                    S.bLo = +e.target.value;
                    if (S.bLo > S.bHi) {
                        S.bHi = S.bLo;
                        $('bandHi').value = S.bHi;
                        $('bandHiV').textContent = S.bHi + ' Hz';
                    }
                    $('bandLoV').textContent = S.bLo + ' Hz';
                    recomputeExtraction();
                    if (!S.playing) rAll();
                    updP();
                });
                $('bandHi').addEventListener('input', e => {
                    S.bHi = +e.target.value;
                    if (S.bHi < S.bLo) {
                        S.bLo = S.bHi;
                        $('bandLo').value = S.bLo;
                        $('bandLoV').textContent = S.bLo + ' Hz';
                    }
                    $('bandHiV').textContent = S.bHi + ' Hz';
                    recomputeExtraction();
                    if (!S.playing) rAll();
                    updP();
                });

                // FS sliders
                $('fsWS').addEventListener('input', e => {
                    S.fsW = +e.target.value;
                    $('fsWV').textContent = S.fsW;
                    $('fsHS').max = Math.floor(S.fsW / 2);
                    if (S.fsH > Math.floor(S.fsW / 2)) {
                        S.fsH = Math.floor(S.fsW / 2);
                        $('fsHS').value = S.fsH;
                        $('fsHV').textContent = S.fsH;
                    }
                    recomputeExtraction();
                    if (!S.playing) rAll();
                    updP();
                });
                $('fsHS').addEventListener('input', e => {
                    S.fsH = +e.target.value;
                    $('fsHV').textContent = S.fsH;
                    recomputeExtraction();
                    if (!S.playing) rAll();
                    updP();
                });
                $('fsOS').addEventListener('input', e => {
                    S.fsOff = +e.target.value;
                    $('fsOV').textContent = Math.floor(
                        (S.fsOff / 1000) *
                            Math.max(0, S.sig ? S.sig.length - S.fsW : 0),
                    );
                    recomputeExtraction();
                    if (!S.playing) rAll();
                });

                const sk = $('seek');
                let sking = false;
                sk.addEventListener('mousedown', () => {
                    sking = true;
                });
                sk.addEventListener('input', () => {
                    if (sking) seekTo(+sk.value / 1e3);
                });
                sk.addEventListener('mouseup', () => {
                    sking = false;
                });
                sk.addEventListener('change', () => {
                    seekTo(+sk.value / 1e3);
                    sking = false;
                });

                document.addEventListener('keydown', e => {
                    if (e.target.tagName === 'INPUT') return;
                    if (e.code === 'Space') {
                        e.preventDefault();
                        togPlay();
                    }
                    if (e.code === 'Escape') stopA();
                    if (e.code === 'KeyA') togAn();
                    if (e.code === 'KeyE') togExtPlay();
                });
                window.addEventListener('resize', () => {
                    sCK = '';
                    if (!S.playing) rAll();
                });
            }

            ldP('tones');
            init();
        </script>
    </body>
</html>
